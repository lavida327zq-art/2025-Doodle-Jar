<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2025 Doodle Jar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Patrick Hand', 'Ma Shan Zheng', cursive, sans-serif;
            margin: 0;
            overflow-x: hidden;
            background-color: #fdfdfd;
        }
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Paper Grid Background */
        .bg-grid-paper {
            background-image: 
                linear-gradient(#a5b4fc 1px, transparent 1px), 
                linear-gradient(90deg, #a5b4fc 1px, transparent 1px);
            background-size: 24px 24px;
        }
        /* Keyframes */
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(var(--r, 0deg)); }
            50% { transform: translateY(-5px) rotate(calc(var(--r, 0deg) + 5deg)); }
        }
        .star-float {
            animation: float 3s infinite ease-in-out;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5) rotate(var(--r)); }
            100% { opacity: 1; transform: scale(1) rotate(var(--r)); }
        }
        .animate-pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes stampBounce {
            0% { transform: scale(2) rotate(12deg); opacity: 0; }
            100% { transform: scale(1) rotate(12deg); opacity: 0.8; }
        }
        .stamp-anim {
            animation: stampBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s forwards;
        }
        /* Utility to hide/show */
        .hidden { display: none !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-grid-paper min-h-screen text-gray-800 selection:bg-yellow-200 flex flex-col items-center">

    <!-- Global SVG Filter -->
    <svg class="absolute w-0 h-0 pointer-events-none">
        <defs>
            <filter id="squiggle">
                <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="3" result="noise" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
            </filter>
        </defs>
    </svg>

    <!-- Audio Elements -->
    <audio id="bgm" loop src="bgm.mp3"></audio>
    <audio id="sfx" src="pop.mp3"></audio>

    <!-- Music Control -->
    <button id="music-btn" class="fixed top-4 right-4 z-50 p-3 rounded-full bg-white shadow-md border-2 border-gray-700 hover:scale-110 active:scale-95 transition-transform duration-200" style="filter: url(#squiggle)" aria-label="Toggle Background Music">
        <span class="text-2xl" id="music-icon">ğŸ”‡</span>
    </button>

    <!-- Header & Jar Section -->
    <div class="w-full shrink-0 pt-8 pb-4 flex flex-col items-center justify-center relative z-20 bg-gradient-to-b from-[#fdfdfd] to-transparent">
        <div class="text-center mb-6">
            <h1 class="text-5xl md:text-7xl font-bold text-gray-700 tracking-wide rotate-[-2deg]" style="filter: url(#squiggle)">
                2025 å¹´åº¦å›é¡¾
            </h1>
            <p class="mt-2 text-lg text-gray-500 font-hand">æœ‰äº›æ—¥å­å€¼å¾—è¢«æŠ˜å çè—</p>
        </div>

        <!-- Jar Container -->
        <div class="flex flex-col items-center">
            <div id="jar-container" class="relative w-56 h-72 cursor-pointer group select-none transition-transform active:scale-95">
                <!-- SVG Jar -->
                <svg viewBox="0 0 200 260" class="w-full h-full drop-shadow-md transition-transform duration-300 group-hover:scale-105" style="filter: url(#squiggle)">
                    <!-- Lid -->
                    <path d="M50,20 L50,10 L150,10 L150,20 Q160,20 160,30 L160,40 L40,40 L40,30 Q40,20 50,20 Z" fill="none" stroke="#4b5563" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
                    <line x1="40" y1="25" x2="160" y2="25" stroke="#4b5563" strokeWidth="2" />
                    <!-- Body -->
                    <path d="M45,40 L45,220 Q45,250 75,250 L125,250 Q155,250 155,220 L155,40" fill="rgba(255, 255, 255, 0.4)" stroke="#4b5563" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
                    <!-- Reflections -->
                    <path d="M140,60 Q145,100 140,140" fill="none" stroke="rgba(75, 85, 99, 0.3)" strokeWidth="2" strokeLinecap="round" />
                    <path d="M55,220 Q50,230 65,235" fill="none" stroke="rgba(75, 85, 99, 0.3)" strokeWidth="2" strokeLinecap="round" />
                </svg>

                <!-- Stars Inside -->
                <div id="jar-stars" class="absolute inset-0 top-10 left-4 right-4 bottom-4 overflow-hidden pointer-events-none">
                    <!-- Stars injected via JS -->
                </div>

                <!-- Label -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none">
                    <div class="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-sm border border-gray-400 rotate-[-2deg]" style="filter: url(#squiggle)">
                        <span id="stars-count" class="text-2xl font-bold text-gray-700 block">0</span>
                        <span class="block text-xs text-gray-500 uppercase tracking-widest">Left</span>
                    </div>
                </div>
            </div>
            
            <!-- Shadow -->
            <div class="w-48 h-4 bg-gray-300/30 rounded-full blur-sm -mt-4 -z-10"></div>
            
            <!-- Hint Text -->
            <p id="hint-text" class="mt-6 text-gray-500 font-hand animate-pulse">
                âœ¨ ç‚¹å‡»ç“¶å­é‡Œçš„æ˜Ÿæ˜Ÿå¡«å†™å¹´åº¦å›é¡¾ä¾¿ç­¾å§~
            </p>
        </div>
    </div>

    <!-- Wall Section -->
    <div class="w-full relative z-10 pb-32">
        <div id="wall-container" class="max-w-7xl mx-auto px-4 py-8 flex flex-wrap justify-center items-start gap-6 md:gap-8">
            <!-- Notes injected via JS -->
            <div id="empty-wall-msg" class="text-center text-gray-300 text-xl mt-12 font-hand rotate-1 select-none hidden">
                å›å¿†å¢™ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»æ˜Ÿæ˜Ÿå¼€å§‹è®°å½•å§ã€‚
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm transition-opacity duration-300 hidden">
        <div id="modal-content" class="relative z-10 w-full max-w-sm aspect-square shadow-xl flex flex-col p-8 transition-transform" style="border-radius: 2px 2px 25px 2px; filter: url(#squiggle); transform-origin: center;">
            
            <!-- Tape -->
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-8 bg-white/50 transform -rotate-2" style="filter: url(#squiggle)"></div>

            <div class="flex-1 flex flex-col items-center justify-center text-center space-y-6">
                <div class="relative w-full">
                    <h2 id="modal-question" class="text-2xl font-bold leading-relaxed min-h-[4rem]"></h2>
                </div>

                <div class="w-full space-y-2">
                    <input id="modal-input" type="text" placeholder="Write your thought..." class="w-full bg-transparent border-b-2 border-gray-400 focus:border-gray-600 outline-none text-xl text-center pb-1 font-hand placeholder:text-gray-400/70" autocomplete="off" />
                </div>
            </div>

            <div class="mt-4 text-center space-x-4">
                <button id="modal-cancel" class="text-lg font-bold px-4 py-2 text-gray-500 hover:text-gray-700 font-hand">Cancel</button>
                <button id="modal-submit" disabled class="text-lg font-bold px-6 py-2 border-2 border-gray-700 rounded-full transition-all transform hover:scale-105 active:scale-95 border-gray-300 bg-gray-100 text-gray-400 cursor-not-allowed" style="filter: url(#squiggle)">Pin It</button>
            </div>
        </div>
    </div>

    <script>
        // --- Constants & Data ---
        const INITIAL_QUESTIONS = [
          "ä½ ä»Šå¹´åšäº†å“ªäº›ä¹‹å‰ä»æœªåšè¿‡çš„äº‹ï¼Ÿ", "ä½ æœ‰æ²¡æœ‰éµå®ˆå¹´åˆæ—¶å’Œè‡ªå·±è®¸ä¸‹çš„çº¦å®šï¼Ÿ", "ä½ èº«è¾¹æœ‰äººç”Ÿå­©å­äº†å—ï¼Ÿ",
          "ä½ èº«è¾¹æœ‰äººå»ä¸–äº†å—ï¼Ÿ", "ä½ å»äº†å“ªäº›åŸå¸‚/å·/å›½å®¶ï¼Ÿ", "æ˜å¹´ä½ æƒ³è¦è·å¾—å“ªäº›ä½ ä»Šå¹´æ²¡æœ‰çš„ä¸œè¥¿ï¼Ÿ",
          "ä»Šå¹´çš„å“ªä¸ªæˆ–å“ªäº›æ—¥å­ä¼šé“­åˆ»åœ¨ä½ çš„è®°å¿†ä¸­ï¼Œä¸ºä»€ä¹ˆï¼Ÿ", "ä½ ä»Šå¹´æœ€å¤§çš„æˆå°±æ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ ä»Šå¹´æœ€å¤§çš„å¤±è´¥æ˜¯ä»€ä¹ˆï¼Ÿ",
          "ä½ ä»Šå¹´è¿˜é‡åˆ°è¿‡å“ªäº›å›°éš¾ï¼Ÿ", "ä½ ä»Šå¹´æ˜¯å¦ç”Ÿè¿‡ç—…æˆ–å—è¿‡ä¼¤ï¼Ÿ", "ä½ ä»Šå¹´ä¹°è¿‡çš„æœ€å¥½çš„ä¸œè¥¿æ˜¯ä»€ä¹ˆï¼Ÿ",
          "è°çš„è¡Œä¸ºå€¼å¾—å»è¡¨æ‰¬ï¼Ÿ", "è°çš„è¡Œä¸ºä»¤ä½ æ„Ÿåˆ°éœ‡æƒŠï¼Ÿ", "ä½ å¤§éƒ¨åˆ†çš„é’±éƒ½èŠ±åˆ°å“ªé‡Œå»äº†ï¼Ÿ",
          "æœ‰ä»€ä¹ˆäº‹è®©ä½ æ„Ÿåˆ°è¶…çº§ã€è¶…çº§ã€è¶…çº§å…´å¥‹ï¼Ÿ", "å“ªé¦–æ­Œä¼šæ°¸è¿œè®©ä½ æƒ³èµ·è¿™ä¸€å¹´ï¼Ÿ", "ä¸å»å¹´çš„è¿™ä¸ªæ—¶å€™ç›¸æ¯”ï¼Œä½ æ˜¯ï¼šæ„Ÿåˆ°æ›´å¿«ä¹è¿˜æ˜¯æ›´æ‚²ä¼¤äº†ï¼Ÿ",
          "ä½ å¸Œæœ›è‡ªå·±èƒ½åšå¾—æ›´å¤šçš„æ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ å¸Œæœ›è‡ªå·±èƒ½åšå¾—æ›´å°‘çš„æ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ æ˜¯å¦‚ä½•åº¦è¿‡èŠ‚å‡æ—¥çš„ï¼Ÿ",
          "ä½ ä»Šå¹´å å…¥çˆ±æ²³äº†å—ï¼Ÿ", "ä½ æ˜¯å¦æœ‰è®¨åŒæŸä¸ªä½ å»å¹´æ­¤æ—¶ä¸è§‰å¾—è®¨åŒçš„äººå‘¢ï¼Ÿ", "ä½ æœ€å–œæ¬¢çš„ç”µè§†èŠ‚ç›®æ˜¯ä»€ä¹ˆï¼Ÿ",
          "ä½ è¯»è¿‡æœ€å¥½çš„ä¸€æœ¬ä¹¦æ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ ä»Šå¹´å‘ç°çš„æœ€å¥½å¬çš„ä¸€é¦–æ­Œæ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ ä»Šå¹´çœ‹è¿‡æœ€å–œæ¬¢çš„ä¸€éƒ¨ç”µå½±æ˜¯ä»€ä¹ˆï¼Ÿ",
          "ä½ ä»Šå¹´åƒè¿‡æœ€å¥½åƒçš„ä¸€é¡¿é¥­æ˜¯ä»€ä¹ˆï¼Ÿ", "æœ‰ä»€ä¹ˆæ˜¯ä½ æƒ³è¦ä¸”å¾—åˆ°äº†çš„ï¼Ÿ", "æœ‰ä»€ä¹ˆæ˜¯ä½ æƒ³è¦å´æ²¡æœ‰å¾—åˆ°çš„ï¼Ÿ",
          "ä½ ç”Ÿæ—¥é‚£å¤©åšäº†ä»€ä¹ˆï¼Ÿ", "æœ‰ä»€ä¹ˆè¿˜æœªå‘ç”Ÿçš„äº‹ï¼Œå¦‚æœå‘ç”Ÿäº†ï¼Œä¼šè®©ä½ çš„è¿™ä¸€å¹´å˜å¾—æ— æ¯”æ»¡è¶³ï¼Ÿ",
          "ä½ ä¼šå¦‚ä½•æè¿°ä½ ä»Šå¹´çš„ä¸ªäººæ—¶å°šé£æ ¼ï¼Ÿ", "æ˜¯ä»€ä¹ˆè®©ä½ ä¿æŒç†æ™ºï¼Ÿ", "ä½ æœ€æ¬£èµå“ªä¸ªåäºº / å…¬ä¼—äººç‰©ï¼Ÿ",
          "å“ªä¸ªæ”¿æ²»é—®é¢˜æœ€ä»¤ä½ æœ‰æ„Ÿè€Œå‘ï¼Ÿ", "ä½ æƒ³å¿µå“ªäº›äººï¼Ÿ", "åœ¨ä½ æ–°è®¤è¯†çš„äººä¹‹ä¸­ï¼Œè°æ˜¯æœ€å¥½çš„ï¼Ÿ",
          "ä»Šå¹´ä½ å­¦åˆ°äº†ä»€ä¹ˆå®è´µçš„äººç”Ÿç»éªŒï¼Ÿ", "èƒ½å¤Ÿæ€»ç»“ä½ è¿™ä¸€å¹´çš„ä¸€å¥è¯æ˜¯ä»€ä¹ˆï¼Ÿ"
        ];
        
        const STAMP_TYPES = ['rabbit', 'cat', 'bear', 'star', 'heart'];
        
        const STAMP_SVGS = {
            rabbit: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="12" cy="15" r="5"/><path d="M9 11C9 11 7 5 9 3C11 1 11 5 11 8" strokeLinecap="round"/><path d="M15 11C15 11 17 5 15 3C13 1 13 5 13 8" strokeLinecap="round"/><circle cx="10.5" cy="14" r="0.5" fill="currentColor"/><circle cx="13.5" cy="14" r="0.5" fill="currentColor"/><path d="M11 16L12 17L13 16" strokeLinecap="round"/></svg>`,
            cat: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 5C10 5 9 7 9 7L7 5L5 9C5 9 6 12 6 14C6 17.3137 8.68629 20 12 20C15.3137 20 18 17.3137 18 14C18 12 19 9 19 9L17 5L15 7C15 7 14 5 12 5Z"/><path d="M9 14L8 15" strokeLinecap="round"/><path d="M15 14L16 15" strokeLinecap="round"/><circle cx="10.5" cy="13" r="0.5" fill="currentColor"/><circle cx="13.5" cy="13" r="0.5" fill="currentColor"/><path d="M11.5 16C11.5 16 12 16.5 12.5 16" strokeLinecap="round"/></svg>`,
            bear: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M7 6C7 6 5 4 4 6C3 8 5 9 5 9" strokeLinecap="round"/><path d="M17 6C17 6 19 4 20 6C21 8 19 9 19 9" strokeLinecap="round"/><circle cx="12" cy="13" r="8"/><circle cx="10" cy="11" r="1" fill="currentColor"/><circle cx="14" cy="11" r="1" fill="currentColor"/><ellipse cx="12" cy="15" rx="2.5" ry="1.5"/><circle cx="12" cy="14.5" r="0.5" fill="currentColor"/></svg>`,
            star: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>`,
            heart: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/><path d="M18 6L19 5" strokeLinecap="round"/><path d="M6 6L5 5" strokeLinecap="round"/></svg>`
        };

        const STORAGE_KEY = 'doodle_jar_data_2025';

        // --- State Management ---
        let appState = {
            questions: [],
            notes: [],
            editingNoteId: null,
            isMusicPlaying: false
        };

        // --- DOM Elements ---
        const bgm = document.getElementById('bgm');
        const sfx = document.getElementById('sfx');
        const musicBtn = document.getElementById('music-btn');
        const musicIcon = document.getElementById('music-icon');
        const jarContainer = document.getElementById('jar-container');
        const jarStarsContainer = document.getElementById('jar-stars');
        const starsCountEl = document.getElementById('stars-count');
        const hintText = document.getElementById('hint-text');
        const wallContainer = document.getElementById('wall-container');
        const emptyWallMsg = document.getElementById('empty-wall-msg');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const modalQuestion = document.getElementById('modal-question');
        const modalInput = document.getElementById('modal-input');
        const modalCancel = document.getElementById('modal-cancel');
        const modalSubmit = document.getElementById('modal-submit');

        // --- Helper Functions ---
        function getThemeForCount(count) {
            if (count <= 10) return { paper: 'bg-green-100', ink: 'text-green-900', accent: 'bg-green-500' };
            if (count <= 20) return { paper: 'bg-rose-100', ink: 'text-rose-900', accent: 'bg-rose-500' };
            if (count <= 30) return { paper: 'bg-blue-100', ink: 'text-blue-900', accent: 'bg-blue-500' };
            return { paper: 'bg-yellow-100', ink: 'text-gray-900', accent: 'bg-yellow-500' };
        }

        function loadState() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                appState.questions = parsed.questions || [];
                appState.notes = parsed.notes || [];
            } else {
                appState.questions = [...INITIAL_QUESTIONS];
                appState.notes = [];
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                questions: appState.questions,
                notes: appState.notes
            }));
        }

        // --- Render Functions ---
        function renderStars() {
            const count = appState.questions.length;
            starsCountEl.textContent = count;
            
            if (count === 0) {
                hintText.textContent = "ğŸ‰ ç“¶å­ç©ºäº†ï¼æ–°å¹´å¿«ä¹ï¼";
            } else {
                hintText.textContent = "âœ¨ ç‚¹å‡»ç“¶å­é‡Œçš„æ˜Ÿæ˜Ÿå¡«å†™å¹´åº¦å›é¡¾ä¾¿ç­¾å§~";
            }

            // Simple diffing: clear and rebuild for simplicity
            jarStarsContainer.innerHTML = '';
            
            const colors = ['#fde047', '#bef264', '#fcd34d', '#86efac', '#93c5fd'];
            
            // Limit rendered stars to 40 or count to avoid performance issues if list grows
            const starCountToRender = Math.min(count, 40);

            for(let i=0; i<starCountToRender; i++) {
                const star = document.createElement('div');
                star.className = 'absolute star-float';
                
                // Random positioning
                const x = Math.random() * 90 + 40; // Approx range inside jar
                const y = Math.random() * 160 + 20;
                const scale = 0.6 + Math.random() * 0.4;
                const rotation = Math.random() * 360;
                const delay = Math.random() * 2;
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                star.style.left = `${x}px`;
                star.style.top = `${y}px`;
                star.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
                star.style.animationDelay = `${delay}s`;
                star.style.setProperty('--r', `${rotation}deg`);

                star.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" stroke="#4b5563" stroke-width="1.5" stroke-linejoin="round" fill="${color}" style="filter: url(#squiggle)">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                    </svg>
                `;
                jarStarsContainer.appendChild(star);
            }
        }

        function renderWall() {
            // Remove existing notes but keep empty message
            const notes = wallContainer.querySelectorAll('.note-item');
            notes.forEach(n => n.remove());

            if (appState.notes.length === 0) {
                emptyWallMsg.classList.remove('hidden');
                return;
            } else {
                emptyWallMsg.classList.add('hidden');
            }

            appState.notes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = `note-item relative w-64 h-64 ${note.theme.paper} shadow-sm p-6 flex flex-col items-center justify-center text-center overflow-hidden shrink-0 mb-5 cursor-pointer hover:scale-105 hover:rotate-0 transition-all duration-300 animate-pop-in`;
                noteEl.style.borderRadius = '2px 2px 15px 2px';
                noteEl.style.filter = 'url(#squiggle)';
                noteEl.style.transform = `rotate(${note.rotation}deg)`;
                noteEl.style.setProperty('--r', `${note.rotation}deg`);
                noteEl.title = "ç‚¹å‡»ä¿®æ”¹ä¾¿ç­¾";
                
                noteEl.onclick = () => openModalForEdit(note);

                // Stamp SVG
                const stampSvg = STAMP_SVGS[note.stamp];

                noteEl.innerHTML = `
                    <!-- Tape -->
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-6 bg-white/40 transform -rotate-1 shadow-sm"></div>
                    
                    <!-- Content -->
                    <div class="flex-1 flex flex-col justify-center gap-3 w-full pointer-events-none">
                        <p class="text-sm text-gray-500 font-hand leading-tight line-clamp-3 italic">"${note.question}"</p>
                        <div class="w-full h-px bg-gray-400/20 my-1"></div>
                        <p class="text-xl font-hand font-bold leading-tight break-words ${note.theme.ink}">${note.answer}</p>
                    </div>

                    <!-- Stamp -->
                    <div class="absolute bottom-3 right-3 text-red-500/70 pointer-events-none transform rotate-12 opacity-80 stamp-anim">
                        <div class="relative w-12 h-12">
                            ${stampSvg}
                            <div class="absolute inset-0 rounded-full border-2 border-dashed border-current opacity-50 scale-125"></div>
                        </div>
                    </div>
                `;
                wallContainer.appendChild(noteEl);
            });
        }

        // --- Actions ---
        function toggleMusic() {
            if (bgm.paused) {
                bgm.play().then(() => {
                    appState.isMusicPlaying = true;
                    musicIcon.textContent = 'ğŸµ';
                }).catch(e => console.log("Audio play failed:", e));
            } else {
                bgm.pause();
                appState.isMusicPlaying = false;
                musicIcon.textContent = 'ğŸ”‡';
            }
        }

        function playSfx() {
            sfx.currentTime = 0;
            sfx.play().catch(e => console.error("SFX error", e));
        }

        function triggerConfetti() {
            if (window.confetti) {
                const duration = 2000;
                const end = Date.now() + duration;

                (function frame() {
                    window.confetti({
                        particleCount: 5,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: ['#a786ff', '#fd8bbc', '#eca184', '#f8deb1']
                    });
                    window.confetti({
                        particleCount: 5,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: ['#a786ff', '#fd8bbc', '#eca184', '#f8deb1']
                    });

                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                }());
            }
        }

        // --- Modal Logic ---
        function openModalForNew() {
            if (appState.questions.length === 0) return;
            
            playSfx();
            appState.editingNoteId = null;
            
            const question = appState.questions[0];
            const theme = getThemeForCount(appState.questions.length);
            
            setupModalUI(question, '', theme, 'Pin It');
        }

        function openModalForEdit(note) {
            appState.editingNoteId = note.id;
            setupModalUI(note.question, note.answer, note.theme, 'Update');
        }

        function setupModalUI(question, answer, theme, btnText) {
            modalQuestion.textContent = question;
            modalQuestion.className = `text-2xl font-bold leading-relaxed min-h-[4rem] ${theme.ink}`;
            
            modalInput.value = answer;
            modalInput.className = `w-full bg-transparent border-b-2 border-gray-400 focus:border-gray-600 outline-none text-xl text-center pb-1 font-hand placeholder:text-gray-400/70 ${theme.ink}`;
            
            // Update Modal Background Theme
            // Remove old theme classes first
            modalContent.classList.remove('bg-green-100', 'bg-rose-100', 'bg-blue-100', 'bg-yellow-100');
            modalContent.classList.add(theme.paper);
            
            modalSubmit.textContent = btnText;
            updateSubmitButton();

            modal.classList.remove('hidden');
            setTimeout(() => modalInput.focus(), 100);
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function handleSubmit() {
            const text = modalInput.value.trim();
            if (!text) return;

            if (appState.editingNoteId) {
                // Edit existing
                const noteIndex = appState.notes.findIndex(n => n.id === appState.editingNoteId);
                if (noteIndex !== -1) {
                    appState.notes[noteIndex].answer = text;
                }
            } else {
                // New Note
                const question = appState.questions[0];
                const theme = getThemeForCount(appState.questions.length);
                
                const newNote = {
                    id: Date.now().toString(),
                    question: question,
                    answer: text,
                    rotation: (Math.random() * 6) - 3,
                    stamp: STAMP_TYPES[Math.floor(Math.random() * STAMP_TYPES.length)],
                    theme: theme,
                    timestamp: Date.now()
                };
                
                appState.notes.unshift(newNote); // Add to top
                appState.questions.shift(); // Remove used question
                
                // Check Milestones
                const remaining = appState.questions.length;
                if ([30, 20, 10, 0].includes(remaining)) {
                    triggerConfetti();
                }
            }

            saveState();
            renderStars(); // Update stars count
            renderWall(); // Update wall
            closeModal();
        }

        function updateSubmitButton() {
            const hasText = modalInput.value.trim().length > 0;
            modalSubmit.disabled = !hasText;
            if (hasText) {
                modalSubmit.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                modalSubmit.classList.add('bg-white', 'text-gray-800', 'shadow-md', 'cursor-pointer');
            } else {
                modalSubmit.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                modalSubmit.classList.remove('bg-white', 'text-gray-800', 'shadow-md', 'cursor-pointer');
            }
        }

        // --- Event Listeners ---
        musicBtn.addEventListener('click', toggleMusic);
        jarContainer.addEventListener('click', openModalForNew);
        modalCancel.addEventListener('click', closeModal);
        modalSubmit.addEventListener('click', handleSubmit);
        
        modalInput.addEventListener('input', updateSubmitButton);
        modalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleSubmit();
        });

        // Initialize
        loadState();
        renderStars();
        renderWall();

    </script>
</body>
</html>
